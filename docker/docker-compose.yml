# Alexandrian Sandbox: local Filecoin-ready stack for testing the runtime.
# The runtime (Gatekeeper + Meter) runs inside the API service.

services:
  # 1. THE BLOCKCHAIN (Hardhat / FVM Emulator)
  # Runs Registry.sol and handles $SCRIBE tokens (v2: uses Dockerfile to avoid ESM/resolution issues)
  blockchain:
    build:
      context: ..
      dockerfile: docker/Dockerfile.blockchain
    ports:
      - "8545:8545"

  # 2. THE STORAGE (IPFS Node)
  # Handles "Hot Storage" for quick knowledge retrieval
  ipfs:
    image: ipfs/kubo:latest
    ports:
      - "4001:4001"   # libp2p
      - "5001:5001"   # API
      - "8080:8080"   # Gateway

  # 3. THE CACHE (Redis)
  # Powers the RoyaltyGraph traversal for instant payouts
  cache:
    image: redis:alpine
    ports:
      - "6379:6379"

  # 4. THE API & RUNTIME
  # The brain that connects the CLI to the storage and chain
  api:
    build:
      context: ..
      dockerfile: docker/Dockerfile.api
    # Optional: when packages/api exists, add env_file: [../packages/api/.env] for overrides.
    # M1: stack runs without api/.env; required vars are in environment below.
    environment:
      # Publicly known Hardhat test key â€” local dev only. Never use real keys here; use env_file or secrets in production.
      DEPLOYER_PRIVATE_KEY: "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80"
      CHAIN_RPC_URL: "http://blockchain:8545"
      RPC_URL: "http://blockchain:8545"
      IPFS_NODE: "http://ipfs:5001"
      REDIS_URL: "redis://cache:6379"
      DATABASE_URL: "redis://cache:6379"
      PORT: "3000"
    depends_on:
      - blockchain
      - ipfs
      - cache
    ports:
      - "3000:3000"
